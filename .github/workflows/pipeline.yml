name: Continuous Integration

on:
  push:
    branches: [ main ]

env:
  GO_VERSION: 1.18
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  Build:
    runs-on: ubuntu-latest
    steps:
    - 
      name: Checkout Code
      uses: actions/checkout@v3
    - 
      name: Configure Go Environment    
      uses: actions/setup-go@v3
      with:
        go-version: ${{ env.GO_VERSION }}
    - 
      name: Build Go Module
      run: |
        go build cmd/wicked/main.go
    - 
      name: Test Go Module
      run: |
        go test ./...
        
  # Security1:
  #   runs-on: ubuntu-latest
  #   needs: [Build]
  #   name: Security Scan (Trivy)
  #   steps:
  #   - 
  #     name: Checkout Code
  #     uses: actions/checkout@v3
  #   - 
  #     name: Build Container
  #     run: |
  #       docker build -t trivy:scan .
  #   - 
  #     name: Trivy Scan (Container) - Critial & High
  #     uses: aquasecurity/trivy-action@master
  #     with:
  #       image-ref: 'trivy:scan'
  #       exit-code: '1'
  #       ignore-unfixed: true
  #       vuln-type: 'os,library'
  #       severity: 'CRITICAL,HIGH'
  #       format: 'sarif'
  #       output: 'trivy-results-crit.sarif'
  #   - 
  #     name: Trivy Scan (Container) - Medium, Low & Unknown
  #     uses: aquasecurity/trivy-action@master
  #     with:
  #       image-ref: 'trivy:scan'
  #       exit-code: '0'
  #       ignore-unfixed: true
  #       vuln-type: 'os,library'
  #       severity: 'MEDIUM,LOW,UNKNOWN'
  #       format: 'sarif'
  #       output: 'trivy-results-mid.sarif'
  #   - 
  #     name: Upload Trivy Results (GitHub Security) - Critial & High
  #     uses: github/codeql-action/upload-sarif@v2
  #     if: always() 
  #     with:
  #       category: "Critial & High"
  #       sarif_file: 'trivy-results-crit.sarif'
  #   - 
  #     name: Upload Trivy Results (GitHub Security) - Medium, Low & Unknown
  #     uses: github/codeql-action/upload-sarif@v2
  #     if: always() 
  #     with:
  #       category: "Medium, Low & Unknown"
  #       sarif_file: 'trivy-results-mid.sarif'
        
  # Security2:
  #   runs-on: ubuntu-latest
  #   needs: [Build]
  #   name: Security Scan (CodeQL)
  #   steps:
  #   - 
  #     name: Checkout Code
  #     uses: actions/checkout@v3
  #   - 
  #     name: Initialize CodeQL Scanner
  #     uses: github/codeql-action/init@v2
  #   -  
  #     name: Autobuild
  #     uses: github/codeql-action/autobuild@v2
  #   -
  #     name: Perform CodeQL Analysis
  #     uses: github/codeql-action/analyze@v2
      
  Docker:
    runs-on: ubuntu-latest
    needs: [Build]
    steps:
    - 
      name: Checkout Code
      uses: actions/checkout@v3
    - 
      name: Login to Docker Container Repository
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - 
      name: Extract metadata (tags, labels) for Docker
      id: meta
      uses: docker/metadata-action@v4
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
    - 
      name: Build & Push Docker Image
      uses: docker/build-push-action@v3
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
